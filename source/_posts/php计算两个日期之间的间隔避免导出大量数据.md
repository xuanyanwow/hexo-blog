---
title: 'php计算两个日期之间的间隔,避免导出大量数据'
tags:
  - PHP
id: '178'
categories:
  - - PHP
  - - 常见问题
date: 2019-09-17 15:23:10
---

# 写在前面

在做系统业务功能的时候，有的时候业务人员会进行超大范围地导出excel表格，导致`内存、CPU占用飙升`。 这对于系统的平滑运行不太友好，应该进行导出任务排队、限制范围等操作来控制频率、资源使用率。

# 探索

## 导出任务排队

这里讲讲实现思路：

*   前端请求服务端接口，告诉它要导出的日期范围、内容
*   服务端记录，插入队列
*   服务端监控脚本（可以用easyswoole等常驻型应用来完成），生成队列里的excel文件，把任务标注成已经成功、对应的文件名
*   前端请求任务之后，间隔轮询后端，是否服务端导出完成，是的话则根据返回文件名下载文件

## 限制数据范围

这是比较重要的点，因为如果是不限制数据筛选范围，使用了排队导出的架构之后，也可能导致机器资源占用过高（而且有被攻击的风险！） 我们可以根据筛选的日期范围，比如不能间隔超过50天，来限制，那么就要判断两个日期差距的日期了。 这里附带一小段代码

```php
$start = "2019-9-17 15:11:38";
$end   = "2019-9-01 15:11:45";

$diff = strtotime($start) - strtotime($end);

$diffHour = bcdiv($diff, 60 * 60, 2); // 差距的小时
$diffDay  = bcdiv($diffHour,24,2); // 差距的天数
if ($diffDay > 50){
    echo "范围过大，不可间隔50天";die;
}
echo "....";
```